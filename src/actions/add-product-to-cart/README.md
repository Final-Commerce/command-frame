# addProductToCart

Adds the currently active product to the cart in the parent application. The product must be set as active first using `setProductActive`.

## Parameters

### `AddProductToCartParams`

```typescript
interface AddProductToCartParams {
    productId?: string; // Optional, ID of product to add. If not provided, uses active product.
    variantId?: string; // Optional, ID of variant to add. If not provided, uses active variant or first variant.
    quantity?: number;  // Optional, default: 1
}
```

#### `productId` (optional)

The ID of the specific product to add. If provided, the system will attempt to find this product. If not provided, the currently active product will be used.

#### `variantId` (optional)

The ID of the specific variant to add. If provided, the system will attempt to find this variant. If not provided, the system will use the active variant or default to the first variant.

#### `quantity` (optional)

The quantity of the product to add to the cart. If not provided:
1. Defaults to 1

**Note:** If the product is already in the cart, the quantity will be added to the existing quantity (not replaced).

## Response

### `AddProductToCartResponse`

```typescript
interface AddProductToCartResponse {
    success: boolean;
    productId: string;
    variantId: string;
    name: string;
    quantity: number;
    timestamp: string;
}
```

#### `success` (boolean)

Indicates whether the product was successfully added to the cart.

#### `productId` (string)

The ID of the product that was added to the cart.

#### `variantId` (string)

The ID of the variant that was added to the cart.

#### `name` (string)

The name of the product that was added to the cart.

#### `quantity` (number)

The quantity that was added to the cart (may be different from requested if product was already in cart).

#### `timestamp` (string)

ISO 8601 timestamp string (e.g., `"2024-01-01T00:00:00.000Z"`) indicating when the response was generated by the handler.

## Usage

```typescript
import { command } from '@final-commerce/command-frame';
```

## Usage Examples

### Add Active Product to Cart (Default)

Add the active product to cart using default quantity (1):

```typescript
import { command } from '@final-commerce/command-frame';

// First, set a product as active
await command.setProductActive({
    variantId: 'variant-id-123'
});

// Then add to cart
const result = await command.addProductToCart();

console.log(`Added ${result.name} (quantity: ${result.quantity}) to cart`);
```

### Add Specific Product by ID

Add a specific product and variant directly without setting it active first:

```typescript
const result = await command.addProductToCart({
    productId: 'prod_123',
    variantId: 'var_456',
    quantity: 2
});

console.log(`Added ${result.quantity} items to cart`);
```

### Complete Workflow

Typical workflow: Set product active, add discount, then add to cart:

```typescript
// 1. Set product as active
await command.setProductActive({
    variantId: 'variant-id-123'
});

// 2. Optionally add discount
await command.addProductDiscount({
    amount: 10,
    isPercent: false,
    label: 'Promotion Discount'
});

// 3. Add to cart with quantity
await command.addProductToCart({
    quantity: 2
});
```

### Error Handling

Handle errors when product cannot be found:

```typescript
try {
    const result = await command.addProductToCart({
        productId: 'invalid_id'
    });
} catch (error) {
    console.error('Failed to add product to cart:', error.message);
}
```

## Behavior

When a product is added to the cart:

1. The product is identified (either via params or active state)
2. The quantity is determined (from parameter or default to 1)
3. The product is added to the cart with all its properties:
   - Product ID and variant ID
   - Name, price, and images
   - Tax table information
   - Stock information
   - Any discounts that were applied
   - Quantity
4. If the same variant is already in the cart, the quantities are combined

## Quantity Handling

### New Product in Cart

If the variant is not already in the cart:
- The product is added with the specified quantity

### Existing Product in Cart

If the variant is already in the cart:
- The new quantity is added to the existing quantity
- Example: Cart has 2 items, adding 3 more â†’ Cart now has 5 items

### Stock Limitations

- If stock management is enabled and stock is limited, the quantity may be adjusted based on available stock
- If stock is 0 and not unlimited, the product may not be added or quantity may be set to 0

## Prerequisites

- A product must be identified either by ID parameters or by being set as active using `setProductActive`
- The product must exist and be valid

## Error Handling

The handler will throw errors in the following cases:

### Product Not Found

```typescript
// Throws error if ID is invalid
await command.addProductToCart({ productId: 'invalid' });
```

## Validation Rules

- `quantity` is optional and defaults to 1
- `quantity` should be a positive number
- `productId` and `variantId` are optional but recommended for direct adding

## Real Data Examples

### Example Response

```json
{
  "success": true,
  "productId": "691df9c6c478bada1fb23d31",
  "variantId": "691df9c6c478bada1fb23d55",
  "name": "Final Coffee ",
  "quantity": 1,
  "timestamp": "2025-12-04T19:25:25.607Z"
}
```

### Example Request

```json
{
  "productId": "prod_123",
  "quantity": 2
}
```

## Notes

- Any discounts applied to the active product will be included when adding to cart
- The product's current price (including any discounts) is used when adding to cart
- Stock availability is considered when determining the quantity
- If the product is already in the cart, quantities are combined (not replaced)
