# upsertCustomTableData

Inserts new data or updates existing data in a specific custom table in the parent application's local database. If the data contains an `_id` field, it updates the existing record; otherwise, it creates a new one.

## Parameters

### `UpsertCustomTableDataParams<T>`

```typescript
interface UpsertCustomTableDataParams<T = any> {
    tableName: string;
    data: T;
}
```

#### `tableName` (required)

The name of the custom table to insert or update data in.

#### `data` (required)

The data object to insert or update. The structure should match the field definitions of the custom table.

**For Insert (Create):**
- Do not include `_id`, `createdAt`, or `updatedAt` fields - these are automatically generated
- Include all required fields as defined in the table schema
- Optional fields can be omitted (will use default values if defined)

**For Update:**
- Include the `_id` field of the existing record to update
- Include any fields you want to update
- The `updatedAt` field will be automatically updated

## Response

### `UpsertCustomTableDataResponse<T>`

```typescript
interface UpsertCustomTableDataResponse<T = any> {
    success: boolean;
    data: T;
    timestamp: string;
}
```

#### `success` (boolean)

Indicates whether the data was successfully inserted or updated.

#### `data` (T)

The complete data object after the upsert operation, including all automatically generated fields:
- `_id` (string): Unique identifier (generated for new records)
- `createdAt` (string): Creation timestamp
- `updatedAt` (string): Last update timestamp
- All custom fields from the table schema

#### `timestamp` (string)

ISO 8601 timestamp string (e.g., `"2024-01-01T00:00:00.000Z"`) indicating when the response was generated by the handler.

## Usage

```typescript
import { command } from '@final-commerce/command-frame';
```

## Usage Examples

### Insert New Record

Create a new record in a custom table:

```typescript
import { command } from '@final-commerce/command-frame';

const result = await command.upsertCustomTableData({
    tableName: 'customer_preferences',
    data: {
        customerId: '691df9c6c478bada1fb23d55',
        theme: 'dark',
        notifications: true,
        language: 'en'
    }
});

console.log('Created record:', result.data);
console.log('New record ID:', result.data._id);
```

### Update Existing Record

Update an existing record by including its `_id`:

```typescript
import { command } from '@final-commerce/command-frame';

const result = await command.upsertCustomTableData({
    tableName: 'customer_preferences',
    data: {
        _id: '65a1b2c3d4e5f6g7h8i9j0k3',
        theme: 'light',
        notifications: false
    }
});

console.log('Updated record:', result.data);
```

### TypeScript Type Safety

Use TypeScript generics for type-safe operations:

```typescript
import { command } from '@final-commerce/command-frame';

interface CustomerPreference {
    _id?: string;
    customerId: string;
    theme: 'light' | 'dark';
    notifications: boolean;
    language: string;
    createdAt?: string;
    updatedAt?: string;
}

// Insert
const insertResult = await command.upsertCustomTableData<CustomerPreference>({
    tableName: 'customer_preferences',
    data: {
        customerId: '691df9c6c478bada1fb23d55',
        theme: 'dark',
        notifications: true,
        language: 'en'
    }
});

// Update
const updateResult = await command.upsertCustomTableData<CustomerPreference>({
    tableName: 'customer_preferences',
    data: {
        _id: insertResult.data._id,
        theme: 'light'
    }
});

// Result is typed as CustomerPreference
console.log(`Theme updated to: ${updateResult.data.theme}`);
```

### Bulk Operations

Insert or update multiple records (requires multiple calls):

```typescript
import { command } from '@final-commerce/command-frame';

const preferencesToUpsert = [
    { customerId: 'cust1', theme: 'dark', notifications: true },
    { customerId: 'cust2', theme: 'light', notifications: false },
    { customerId: 'cust3', theme: 'dark', notifications: true }
];

const results = await Promise.all(
    preferencesToUpsert.map(pref =>
        command.upsertCustomTableData({
            tableName: 'customer_preferences',
            data: pref
        })
    )
);

console.log(`Upserted ${results.length} records`);
```

## Error Handling

If the upsert fails, the handler will throw an error. Common error scenarios include:
- Invalid `tableName` (table does not exist)
- Missing required fields (for insert operations)
- Invalid data types for fields
- Invalid `_id` (for update operations when the record doesn't exist)
- Validation errors based on field constraints

## Validation Rules

- `tableName` is required and must reference an existing custom table
- `data` is required and must be a valid object
- All required fields (as defined in the table schema) must be present for insert operations
- Field values must match the defined field types (string, number, boolean, date, json-string)
- For update operations, the `_id` must reference an existing record

## Real Data Examples

### Example Response (Insert)

```json
{
  "success": true,
  "data": {
    "_id": "65a1b2c3d4e5f6g7h8i9j0k3",
    "customerId": "691df9c6c478bada1fb23d55",
    "theme": "dark",
    "notifications": true,
    "language": "en",
    "createdAt": "2024-01-15T12:00:00.000Z",
    "updatedAt": "2024-01-15T12:00:00.000Z"
  },
  "timestamp": "2024-01-15T12:00:00.000Z"
}
```

### Example Request (Insert)

```json
{
  "tableName": "customer_preferences",
  "data": {
    "customerId": "691df9c6c478bada1fb23d55",
    "theme": "dark",
    "notifications": true,
    "language": "en"
  }
}
```

### Example Response (Update)

```json
{
  "success": true,
  "data": {
    "_id": "65a1b2c3d4e5f6g7h8i9j0k3",
    "customerId": "691df9c6c478bada1fb23d55",
    "theme": "light",
    "notifications": false,
    "language": "en",
    "createdAt": "2024-01-15T12:00:00.000Z",
    "updatedAt": "2024-01-15T14:30:00.000Z"
  },
  "timestamp": "2024-01-15T14:30:00.000Z"
}
```

### Example Request (Update)

```json
{
  "tableName": "customer_preferences",
  "data": {
    "_id": "65a1b2c3d4e5f6g7h8i9j0k3",
    "theme": "light",
    "notifications": false
  }
}
```

## Notes

- Custom table data is stored in the local IndexedDB database (LokiJS)
- Data is synchronized with the central MongoDB database via station-sync
- The operation is atomic - either all changes succeed or none do
- Use `getCustomTableFields` to understand the required fields and their types before upserting
- Use `getCustomTableData` to retrieve existing data before updating
- The `createdAt` field is set only on insert and never changes
- The `updatedAt` field is automatically updated on every upsert operation

